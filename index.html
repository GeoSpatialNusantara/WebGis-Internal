<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebGIS Recursive Folder Viewer</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<style>
body { margin:0; display:flex; font-family:Arial; }
#sidebar {
    width:280px;
    background:#f4f4f4;
    padding:10px;
    overflow:auto;
    border-right:1px solid #ccc;
}
#map { flex:1; height:100vh; }
.folder { font-weight:bold; cursor:pointer; margin-top:8px; }
.file { margin-left:20px; }
.subfolder { margin-left:15px; }
</style>
</head>

<body>

<div id="sidebar">
    <h3>Repository Structure</h3>
    <div id="tree"></div>
</div>

<div id="map"></div>

<script>

// ===============================
// 1ï¸âƒ£ BATAS INDONESIA
// ===============================
var indonesiaBounds = [
    [-11.5, 94.5],
    [6.5, 141.5]
];

var map = L.map("map", {
    maxBounds: indonesiaBounds,
    maxBoundsViscosity: 1.0,
    minZoom: 5,
    maxZoom: 18
}).fitBounds(indonesiaBounds);

// ===============================
// 2ï¸âƒ£ BASEMAP
// ===============================
var osm = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { attribution:"Â© OpenStreetMap" }
).addTo(map);

var satellite = L.tileLayer(
    "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
    { attribution:"Satellite" }
);

L.control.layers({
    "OpenStreetMap": osm,
    "Satellite": satellite
}).addTo(map);

// ===============================
// 3ï¸âƒ£ SEARCH
// ===============================
L.Control.geocoder().addTo(map);

// ===============================
// 4ï¸âƒ£ LOAD REPOSITORY RECURSIVE
// ===============================

var repoRoot = "https://api.github.com/repos/GeoSpatialNusantara/WebGis/contents";
var activeLayers = {};

function loadFolder(url, container) {

    fetch(url)
    .then(res => res.json())
    .then(items => {

        items.forEach(item => {

            // Skip index.html
            if (item.name.toLowerCase() === "index.html") return;

            if (item.type === "dir") {

                let folderDiv = document.createElement("div");
                folderDiv.className = "folder";
                folderDiv.textContent = "ðŸ“ " + item.name;

                let subContainer = document.createElement("div");
                subContainer.className = "subfolder";
                subContainer.style.display = "none";

                folderDiv.onclick = function() {
                    subContainer.style.display =
                        subContainer.style.display === "none" ? "block" : "none";
                };

                container.appendChild(folderDiv);
                container.appendChild(subContainer);

                // Recursive call
                loadFolder(item.url, subContainer);

            }

            if (item.type === "file") {

                let fileDiv = document.createElement("div");
                fileDiv.className = "file";

                let checkbox = document.createElement("input");
                checkbox.type = "checkbox";

                checkbox.onchange = function() {

                    if (this.checked && item.name.endsWith(".geojson")) {

                        fetch(item.download_url)
                        .then(r => r.json())
                        .then(data => {

                            var geo = L.geoJSON(data, {
                                onEachFeature: function(feature, layer) {
                                    if (feature.properties) {
                                        layer.bindPopup(
                                            Object.entries(feature.properties)
                                            .map(([k,v]) => k + ": " + v)
                                            .join("<br>")
                                        );
                                    }
                                }
                            }).addTo(map);

                            activeLayers[item.name] = geo;
                        });

                    } else {

                        if (activeLayers[item.name]) {
                            map.removeLayer(activeLayers[item.name]);
                            delete activeLayers[item.name];
                        }

                    }
                };

                fileDiv.appendChild(checkbox);
                fileDiv.appendChild(
                    document.createTextNode(" ðŸ“„ " + item.name)
                );

                container.appendChild(fileDiv);
            }

        });

    });
}

// Load root
loadFolder(repoRoot, document.getElementById("tree"));

</script>

</body>
</html>
