<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>WebGIS - GeoSpatialNusantara</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>

<style>
html,body{margin:0;height:100%;font-family:Segoe UI;}
#map{height:100%;width:100%;}

.sidebar{
position:absolute;
right:0;top:0;
width:330px;height:100%;
background:#ffffff;
overflow:auto;
box-shadow:-4px 0 15px rgba(0,0,0,0.2);
padding:15px;
z-index:1000;
}

h2{margin-top:0;}

.category{
font-weight:bold;
margin-top:12px;
cursor:pointer;
padding:6px;
background:#f1f1f1;
border-radius:6px;
}

.year{
margin-left:15px;
margin-top:6px;
display:flex;
align-items:center;
cursor:pointer;
}

.toggle{
width:14px;height:14px;
border-radius:50%;
background:#ccc;
margin-right:8px;
transition:0.3s;
}

.toggle.active{background:#2ecc71;}

.basemap-btn{
position:absolute;
top:12px;left:12px;
background:white;
padding:8px 10px;
border-radius:6px;
cursor:pointer;
box-shadow:0 2px 6px rgba(0,0,0,0.3);
z-index:1200;
}

.basemap-menu{
position:absolute;
top:55px;left:12px;
background:white;
padding:10px;
border-radius:6px;
display:none;
box-shadow:0 2px 8px rgba(0,0,0,0.3);
z-index:1200;
}

.basemap-menu div{
padding:5px;
cursor:pointer;
}
.basemap-menu div:hover{
background:#eee;
}

.loading{
position:absolute;
top:50%;left:50%;
transform:translate(-50%,-50%);
background:white;
padding:15px 25px;
border-radius:8px;
box-shadow:0 0 15px rgba(0,0,0,0.3);
z-index:2000;
display:none;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="basemap-btn" onclick="toggleBasemap()">☰</div>
<div class="basemap-menu" id="basemapMenu">
<div onclick="setBasemap('osm')">OpenStreetMap</div>
<div onclick="setBasemap('sat')">Satellite</div>
<div onclick="setBasemap('topo')">Topo</div>
</div>

<div class="sidebar">
<h2>Layer Control</h2>
<div id="layerList"></div>
</div>

<div class="loading" id="loading">Loading Data...</div>

<script>

const username="GeoSpatialNusantara";
const repo="WebGis";
const branch="main";
const rootFolder="file";

var map=L.map('map').setView([-2.5,118],5);

var basemaps={
osm:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
sat:L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png'),
topo:L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png')
};

basemaps.osm.addTo(map);

function toggleBasemap(){
let m=document.getElementById("basemapMenu");
m.style.display=m.style.display==="block"?"none":"block";
}

function setBasemap(name){
Object.values(basemaps).forEach(l=>map.removeLayer(l));
basemaps[name].addTo(map);
}

let loadedLayers={};

function showLoading(state){
document.getElementById("loading").style.display=state?"block":"none";
}

showLoading(true);

fetch(`https://api.github.com/repos/${username}/${repo}/git/trees/${branch}?recursive=1`)
.then(res=>res.json())
.then(data=>{

let files=data.tree.filter(item=>
item.path.startsWith(rootFolder+"/") &&
(item.path.endsWith(".kml")||
 item.path.endsWith(".kmz")||
 item.path.endsWith(".zip"))
);

let structure={};

files.forEach(file=>{
let parts=file.path.split("/");
let kategori=parts[1];
let tahun=parts[2];

if(!structure[kategori])structure[kategori]={};
if(!structure[kategori][tahun])structure[kategori][tahun]=[];

structure[kategori][tahun].push(file);
});

buildSidebar(structure);
showLoading(false);

});

function randomColor(){
return '#'+Math.floor(Math.random()*16777215).toString(16);
}

function buildSidebar(structure){

const container=document.getElementById("layerList");

Object.keys(structure).forEach(kategori=>{

let catDiv=document.createElement("div");
catDiv.className="category";
catDiv.innerHTML="▼ "+kategori;

let yearContainer=document.createElement("div");
yearContainer.style.display="none";

catDiv.onclick=()=>{
yearContainer.style.display=
yearContainer.style.display==="none"?"block":"none";
};

container.appendChild(catDiv);
container.appendChild(yearContainer);

Object.keys(structure[kategori]).forEach(tahun=>{

let yearDiv=document.createElement("div");
yearDiv.className="year";

let toggle=document.createElement("span");
toggle.className="toggle";

let label=document.createElement("span");
label.innerText=tahun;

yearDiv.appendChild(toggle);
yearDiv.appendChild(label);
yearContainer.appendChild(yearDiv);

toggle.onclick=()=>{

if(toggle.classList.contains("active")){
toggle.classList.remove("active");
if(loadedLayers[kategori+tahun])
map.removeLayer(loadedLayers[kategori+tahun]);
}
else{
toggle.classList.add("active");

let group=L.layerGroup();
let color=randomColor();

structure[kategori][tahun].forEach(file=>{

let rawUrl=
`https://raw.githubusercontent.com/${username}/${repo}/${branch}/${file.path}`;

let layer=omnivore.kml(rawUrl);

layer.on('ready',function(){
map.fitBounds(layer.getBounds());
});

layer.eachLayer(function(l){
l.setStyle&&l.setStyle({color:color});
let cleanName=file.path.split("/").pop()
.replace(".zip","")
.replace(".kml","")
.replace(".kmz","");
l.bindTooltip(cleanName);
});

layer.addTo(group);

});

group.addTo(map);
loadedLayers[kategori+tahun]=group;
}
};

});

});

}

</script>
</body>
</html>
