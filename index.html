<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>GSN WebGIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{margin:0;height:100%;}
#map{height:100%;}

.sidebar{
position:absolute;
top:0;
left:-320px;
width:300px;
height:100%;
background:#111;
color:white;
padding:15px;
overflow:auto;
transition:.3s;
z-index:1000;
}
.sidebar.active{left:0;}

.toggle-btn{
position:absolute;
top:15px;
left:15px;
background:white;
padding:8px 10px;
border-radius:6px;
cursor:pointer;
z-index:1100;
}

label{display:block;margin:5px 0;cursor:pointer;}
input[type=checkbox]{margin-right:5px;}
h3{border-bottom:1px solid #444;padding-bottom:5px;}
.year{margin-left:15px;}
</style>
</head>
<body>

<div id="map"></div>

<div class="toggle-btn" id="toggleBtn">â˜°</div>

<div class="sidebar" id="sidebar">
<h3>Basemap</h3>
<label><input type="radio" name="base" value="osm" checked> OSM</label>
<label><input type="radio" name="base" value="google"> Google Satellite</label>

<h3>Layer</h3>
<div id="layerContainer"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/togeojson@0.16.0/dist/togeojson.js"></script>

<script>

/* ================= MAP ================= */
var indonesiaBounds = [[-11,94],[6,141]];

var map = L.map('map',{
minZoom:5,
maxBounds: indonesiaBounds,
maxBoundsViscosity:1
}).setView([-2.5,118],5);

/* ================= BASEMAP ================= */
var osm = L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
).addTo(map);

var google = L.tileLayer(
'https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
{
maxZoom:20,
subdomains:['mt0','mt1','mt2','mt3']
});

document.querySelectorAll('input[name="base"]').forEach(r=>{
r.addEventListener('change',function(){
if(this.value==="osm"){
map.removeLayer(google);
map.addLayer(osm);
}else{
map.removeLayer(osm);
map.addLayer(google);
}
});
});

/* ================= SIDEBAR ================= */
var sidebar=document.getElementById("sidebar");
document.getElementById("toggleBtn").onclick=function(){
sidebar.classList.toggle("active");
};

/* ================= LOAD REPO ================= */

var repo="GeoSpatialNusantara/WebGis";
var container=document.getElementById("layerContainer");
var layerStore={};

function loadFolder(url,kategori=null,tahun=null){

fetch(url)
.then(res=>res.json())
.then(data=>{

data.forEach(item=>{

if(item.type==="dir"){

if(!kategori){
createKategori(item);
loadFolder(item.url,item.name,null);
}else if(!tahun){
createTahun(item,kategori);
loadFolder(item.url,kategori,item.name);
}

}

if(item.type==="file"){
if(item.name.endsWith(".zip") || item.name.endsWith(".kmz")){
prepareFile(item,kategori,tahun);
}
}

});

});
}

function createKategori(folder){

layerStore[folder.name]={};

var label=document.createElement("label");
var checkbox=document.createElement("checkbox");
checkbox.type="checkbox";

checkbox.onchange=function(){
var years=layerStore[folder.name];
for(var y in years){
years[y].forEach(layer=>{
if(this.checked){
layer.addTo(map);
}else{
map.removeLayer(layer);
}
});
}
};

label.appendChild(checkbox);
label.append(" "+folder.name);
container.appendChild(label);
}

function createTahun(folder,kategori){

layerStore[kategori][folder.name]=[];

var label=document.createElement("label");
label.className="year";

var checkbox=document.createElement("input");
checkbox.type="checkbox";

checkbox.onchange=function(){
layerStore[kategori][folder.name].forEach(layer=>{
if(this.checked){
layer.addTo(map);
}else{
map.removeLayer(layer);
}
});
};

label.appendChild(checkbox);
label.append(" "+folder.name);
container.appendChild(label);
}

function prepareFile(file,kategori,tahun){

fetch(file.download_url)
.then(res=>res.arrayBuffer())
.then(buffer=>{

if(file.name.endsWith(".zip")){

shp(buffer).then(geojson=>{
var layer=L.geoJSON(geojson,{style:{color:"#00ffff"}});
layerStore[kategori][tahun].push(layer);
});

}

if(file.name.endsWith(".kmz")){

JSZip.loadAsync(buffer).then(zip=>{
zip.forEach(function(relativePath,fileEntry){
if(relativePath.endsWith(".kml")){
fileEntry.async("string").then(function(kmlText){
var parser=new DOMParser();
var kml=parser.parseFromString(kmlText,"text/xml");
var geojson=toGeoJSON.kml(kml);
var layer=L.geoJSON(geojson,{style:{color:"#ffcc00"}});
layerStore[kategori][tahun].push(layer);
});
}
});
});

}

});
}

loadFolder(`https://api.github.com/repos/${repo}/contents/`);

</script>

</body>
</html>
