<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebGIS Folder Viewer</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<style>
body { margin:0; display:flex; font-family:Arial; }
#sidebar {
    width:250px;
    background:#f4f4f4;
    padding:10px;
    overflow:auto;
    border-right:1px solid #ccc;
}
#map { flex:1; height:100vh; }
.folder { font-weight:bold; margin-top:10px; }
.file { margin-left:15px; }
</style>
</head>

<body>

<div id="sidebar">
    <h3>Folder Repository</h3>
    <div id="folderList"></div>
</div>

<div id="map"></div>

<script>

// ============================
// 1️⃣ BATAS INDONESIA
// ============================
var indonesiaBounds = [
    [-11.5, 94.5],
    [6.5, 141.5]
];

var map = L.map("map", {
    maxBounds: indonesiaBounds,
    maxBoundsViscosity: 1.0
}).fitBounds(indonesiaBounds);

// ============================
// 2️⃣ BASEMAP
// ============================
var osm = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { attribution:"© OpenStreetMap" }
).addTo(map);

var satellite = L.tileLayer(
    "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
    { attribution:"Satellite" }
);

L.control.layers({
    "OpenStreetMap": osm,
    "Satellite": satellite
}).addTo(map);

// ============================
// 3️⃣ SEARCH
// ============================
L.Control.geocoder().addTo(map);

// ============================
// 4️⃣ LOAD FOLDER DARI GITHUB
// ============================

var repoAPI = "https://api.github.com/repos/GeoSpatialNusantara/WebGis/contents";
var activeLayers = {};

fetch(repoAPI)
.then(res => res.json())
.then(items => {

    let container = document.getElementById("folderList");

    items.forEach(item => {

        // Tampilkan hanya folder
        if (item.type === "dir") {

            let folderDiv = document.createElement("div");
            folderDiv.className = "folder";

            let checkbox = document.createElement("input");
            checkbox.type = "checkbox";

            let label = document.createElement("span");
            label.textContent = " " + item.name;

            folderDiv.appendChild(checkbox);
            folderDiv.appendChild(label);
            container.appendChild(folderDiv);

            let fileContainer = document.createElement("div");
            container.appendChild(fileContainer);

            checkbox.onchange = function() {

                if (this.checked) {

                    fetch(item.url)
                    .then(r => r.json())
                    .then(files => {

                        files.forEach(file => {

                            if (file.type !== "file") return;

                            let fileDiv = document.createElement("div");
                            fileDiv.className = "file";

                            let fileCheck = document.createElement("input");
                            fileCheck.type = "checkbox";

                            fileCheck.onchange = function() {

                                if (this.checked && file.name.endsWith(".geojson")) {

                                    fetch(file.download_url)
                                    .then(r => r.json())
                                    .then(data => {

                                        var geo = L.geoJSON(data, {
                                            onEachFeature: function(feature, layer) {
                                                if (feature.properties) {
                                                    layer.bindPopup(
                                                        Object.entries(feature.properties)
                                                        .map(([k,v]) => k + ": " + v)
                                                        .join("<br>")
                                                    );
                                                }
                                            }
                                        }).addTo(map);

                                        activeLayers[file.name] = geo;
                                    });
                                } else {
                                    if (activeLayers[file.name]) {
                                        map.removeLayer(activeLayers[file.name]);
                                        delete activeLayers[file.name];
                                    }
                                }
                            };

                            fileDiv.appendChild(fileCheck);
                            fileDiv.appendChild(
                                document.createTextNode(" " + file.name)
                            );

                            fileContainer.appendChild(fileDiv);
                        });

                    });

                } else {
                    fileContainer.innerHTML = "";
                }
            };
        }

    });

})
.catch(err => {
    document.getElementById("folderList").textContent =
        "Gagal memuat repository.";
});

</script>

</body>
</html>
