// ===============================
// 4ï¸âƒ£ LOAD FOLDER + SUBFOLDER + TAHUN
// ===============================

var folderAPI = "https://api.github.com/repos/GeoSpatialNusantara/WebGis/contents/file";
var activeLayers = {};

fetch(folderAPI)
.then(res => {
    if (!res.ok) throw new Error("Folder /file tidak ditemukan");
    return res.json();
})
.then(folders => {

    let container = document.getElementById("folderList");

    folders.forEach(folder => {

        if (folder.type === "dir") {

            // Judul Folder Utama
            let title = document.createElement("div");
            title.innerHTML = "<b>" + folder.name + "</b>";
            container.appendChild(title);

            // Load Subfolder (Kategori)
            fetch(folder.url)
            .then(res => res.json())
            .then(subfolders => {

                subfolders.forEach(sub => {

                    if (sub.type === "dir") {

                        let subDiv = document.createElement("div");
                        subDiv.style.marginLeft = "10px";

                        let subTitle = document.createElement("div");
                        subTitle.innerHTML = "ðŸ“ " + sub.name;
                        subDiv.appendChild(subTitle);

                        // Load Sub-Subfolder (TAHUN)
                        fetch(sub.url)
                        .then(res => res.json())
                        .then(yearFolders => {

                            yearFolders.forEach(year => {

                                if (year.type === "dir") {

                                    let yearDiv = document.createElement("div");
                                    yearDiv.style.marginLeft = "20px";

                                    let checkbox = document.createElement("input");
                                    checkbox.type = "checkbox";

                                    checkbox.onchange = function() {

                                        if (this.checked) {

                                            fetch(year.url)
                                            .then(res => res.json())
                                            .then(files => {

                                                files.forEach(file => {

                                                    if (file.name.endsWith(".geojson")) {

                                                        fetch(file.download_url)
                                                        .then(res => res.json())
                                                        .then(data => {

                                                            var geoLayer = L.geoJSON(data, {
                                                                onEachFeature: function(feature, layer) {
                                                                    if (feature.properties) {
                                                                        let popup = "";
                                                                        for (let key in feature.properties) {
                                                                            popup += key + ": " + feature.properties[key] + "<br>";
                                                                        }
                                                                        layer.bindPopup(popup);
                                                                    }
                                                                }
                                                            }).addTo(map);

                                                            if (!activeLayers[year.path]) {
                                                                activeLayers[year.path] = [];
                                                            }

                                                            activeLayers[year.path].push(geoLayer);

                                                        });

                                                    }

                                                });

                                            });

                                        } else {

                                            if (activeLayers[year.path]) {
                                                activeLayers[year.path].forEach(layer => {
                                                    map.removeLayer(layer);
                                                });
                                                delete activeLayers[year.path];
                                            }

                                        }

                                    };

                                    yearDiv.appendChild(checkbox);
                                    yearDiv.appendChild(
                                        document.createTextNode(" " + year.name)
                                    );

                                    subDiv.appendChild(yearDiv);

                                }

                            });

                        });

                        container.appendChild(subDiv);

                    }

                });

            });

        }

    });

})
.catch(err => {
    document.getElementById("folderList").textContent =
        "Struktur folder tidak ditemukan.";
});
