<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>GSN WebGIS PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

<style>
html, body { margin:0; height:100%; font-family:sans-serif; }
#map { height:100%; }

/* Sidebar */
.sidebar {
    position:absolute;
    top:0;
    left:-300px;
    width:260px;
    height:100%;
    background:#111;
    color:white;
    padding:20px;
    transition:0.3s ease;
    z-index:1000;
    overflow:auto;
}
.sidebar.active { left:0; }

.toggle-btn {
    position:absolute;
    top:15px;
    left:15px;
    background:white;
    border-radius:6px;
    padding:8px 10px;
    cursor:pointer;
    z-index:1100;
    font-size:20px;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

/* Search */
.search-container {
    position:absolute;
    top:15px;
    right:15px;
    z-index:1100;
}
.search-container input {
    padding:8px 35px 8px 10px;
    border-radius:6px;
    border:none;
    width:250px;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
}
.clear-btn {
    position:absolute;
    right:10px;
    top:8px;
    cursor:pointer;
}
</style>
</head>
<body>

<div id="map"></div>

<div class="toggle-btn" id="toggleBtn">☰</div>

<div class="sidebar" id="sidebar">
    <h3>Basemap</h3>
    <label><input type="radio" name="basemap" value="osm" checked> OpenStreetMap</label>
    <label><input type="radio" name="basemap" value="google"> Google Satellite</label>

    <hr>

    <h3>Layer</h3>
    <div id="layerList"></div>
</div>

<div class="search-container">
    <input type="text" id="searchInput" placeholder="Cari lokasi...">
    <span class="clear-btn" id="clearBtn">✖</span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
// ================= MAP =================
var map = L.map('map', {
    zoomControl:false, // zoom button dihapus
}).setView([-2.5,118],5);

// Basemap
var osm = L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
);

var googleSat = L.tileLayer(
    'https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
    {
        maxZoom:20,
        subdomains:['mt0','mt1','mt2','mt3']
    }
);

osm.addTo(map);

// ================= SIDEBAR =================
var sidebar = document.getElementById("sidebar");
var toggleBtn = document.getElementById("toggleBtn");

toggleBtn.onclick = function(){
    sidebar.classList.add("active");
    toggleBtn.style.display="none";
};

map.on("click", function(){
    sidebar.classList.remove("active");
    toggleBtn.style.display="block";
});

// ================= BASEMAP SWITCH =================
document.querySelectorAll('input[name="basemap"]').forEach(radio=>{
    radio.addEventListener('change',function(){
        map.eachLayer(function(layer){
            map.removeLayer(layer);
        });
        if(this.value==="osm"){
            osm.addTo(map);
        } else {
            googleSat.addTo(map);
        }
    });
});

// ================= SEARCH WITH SUGGESTION =================
var geocoder = L.Control.Geocoder.nominatim();

document.getElementById("searchInput").addEventListener("input", function(){
    var query = this.value;
    if(query.length > 3){
        geocoder.geocode(query, function(results){
            if(results.length > 0){
                map.setView(results[0].center, 12, {animate:true});
            }
        });
    }
});

document.getElementById("clearBtn").onclick=function(){
    document.getElementById("searchInput").value="";
};

// ================= AUTO LOAD LAYER DARI GITHUB =================
var repo = "GeoSpatialNusantara/WebGis";

fetch(`https://api.github.com/repos/${repo}/contents/`)
.then(res=>res.json())
.then(data=>{
    data.forEach(folder=>{
        if(folder.type==="dir"){
            fetch(folder.url)
            .then(res=>res.json())
            .then(files=>{
                files.forEach(file=>{
                    if(file.name.endsWith(".geojson")){
                        var checkbox=document.createElement("input");
                        checkbox.type="checkbox";

                        var label=document.createElement("label");
                        label.style.display="block";
                        label.appendChild(checkbox);
                        label.append(" "+file.name);

                        var geoLayer;

                        checkbox.addEventListener("change",function(){
                            if(this.checked){
                                fetch(file.download_url)
                                .then(res=>res.json())
                                .then(geo=>{
                                    geoLayer=L.geoJSON(geo).addTo(map);
                                });
                            } else {
                                map.removeLayer(geoLayer);
                            }
                        });

                        document.getElementById("layerList").appendChild(label);
                    }
                });
            });
        }
    });
});
</script>

</body>
</html>
