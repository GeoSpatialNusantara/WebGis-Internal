<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebGIS - GeoSpatialNusantara</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{margin:0;font-family:Arial;}
#map{height:100vh;width:100%}

/* Sidebar */
#sidebar{
position:absolute;right:0;top:0;
width:360px;height:100%;
background:#f5f5f5;
box-shadow:-3px 0 10px rgba(0,0,0,.2);
transform:translateX(100%);
transition:.3s;
z-index:1000;
overflow:hidden;
}
#sidebar.active{transform:translateX(0)}
#toggleBtn{
position:absolute;top:15px;right:15px;
z-index:1200;padding:8px 12px;
border:none;border-radius:6px;
background:white;cursor:pointer;
box-shadow:0 2px 6px rgba(0,0,0,.2);
}

/* Tabs */
.tabs{display:flex;background:#e0e0e0}
.tab{flex:1;padding:10px;text-align:center;cursor:pointer;font-weight:bold}
.tab.active{background:white;border-bottom:3px solid #2c7be5}
.tab-content{display:none;padding:15px;height:calc(100% - 45px);overflow:auto}
.tab-content.active{display:block}

/* Rows */
.row{display:flex;align-items:center;margin-top:8px}
.arrow{margin-right:6px;cursor:pointer;transition:.3s}
.arrow.rotate{transform:rotate(90deg)}
.toggle{
width:15px;height:15px;border-radius:50%;
background:#bbb;margin-right:8px;cursor:pointer;
transition:.2s;
}
.toggle.active{background:#2c7be5}
.year-container{display:none;margin-left:15px}

input{
width:100%;padding:8px;margin-bottom:10px;
border-radius:6px;border:1px solid #ccc;
}

#loading{
position:absolute;top:50%;left:50%;
transform:translate(-50%,-50%);
background:white;padding:15px 25px;
border-radius:8px;
box-shadow:0 4px 10px rgba(0,0,0,.2);
z-index:2000;
}
</style>
</head>

<body>

<div id="map"></div>
<button id="toggleBtn">☰</button>
<div id="loading">Loading data...</div>

<div id="sidebar">

<div class="tabs">
<div class="tab active" data-tab="basemapTab">Basemap</div>
<div class="tab" data-tab="layerTab">Layer</div>
<div class="tab" data-tab="uploadTab">Upload</div>
</div>

<div id="basemapTab" class="tab-content active">
<div class="row" onclick="switchBasemap('osm')">OpenStreetMap</div>
<div class="row" onclick="switchBasemap('esri')">ESRI Satellite</div>
</div>

<div id="layerTab" class="tab-content">
<input type="text" id="searchInput" placeholder="Cari layer...">
<div id="layerList"></div>
</div>

<div id="uploadTab" class="tab-content">
<input type="file" id="uploadInput" multiple accept=".zip,.kml,.kmz">
</div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://unpkg.com/leaflet-omnivore@latest/leaflet-omnivore.min.js"></script>

<script>
// CONFIG
const OWNER="GeoSpatialNusantara";
const REPO="WebGis";
const BRANCH="main";
const ROOT_FOLDER="file";
const markerImage="./img/point-of-interest.png";

const map=L.map('map').setView([-2.5,118],5);

// Basemap aman (tidak terhapus)
const baseGroup=L.layerGroup().addTo(map);
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
const esri=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
osm.addTo(baseGroup);

function switchBasemap(type){
baseGroup.clearLayers();
(type==="osm"?osm:esri).addTo(baseGroup);
}

// Sidebar
toggleBtn.onclick=()=>sidebar.classList.toggle("active");

// Tabs
document.querySelectorAll(".tab").forEach(tab=>{
tab.onclick=function(){
document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
tab.classList.add("active");
document.getElementById(tab.dataset.tab).classList.add("active");
};
});

let layerStore={};

async function fetchGitHub(path){
const url=`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}?ref=${BRANCH}`;
const res=await fetch(url);
return await res.json();
}

async function loadStructure(){
const container=document.getElementById("layerList");
const categories=await fetchGitHub(ROOT_FOLDER);

for(const cat of categories){
if(cat.type!=="dir") continue;

const row=document.createElement("div");
row.className="row";

const arrow=document.createElement("span");
arrow.className="arrow";
arrow.innerHTML="▶";

const toggle=document.createElement("div");
toggle.className="toggle";

const label=document.createElement("span");
label.innerText=cat.name;

row.append(arrow,toggle,label);
container.appendChild(row);

const yearContainer=document.createElement("div");
yearContainer.className="year-container";
container.appendChild(yearContainer);

arrow.onclick=()=>{
yearContainer.style.display=
yearContainer.style.display==="block"?"none":"block";
arrow.classList.toggle("rotate");
};

const years=await fetchGitHub(cat.path);
for(const year of years){
if(year.type!=="dir") continue;

const yRow=document.createElement("div");
yRow.className="row";

const yToggle=document.createElement("div");
yToggle.className="toggle";
yToggle.dataset.path=year.path;

const yLabel=document.createElement("span");
yLabel.innerText=year.name;

yRow.append(yToggle,yLabel);
yearContainer.appendChild(yRow);

const files=await fetchGitHub(year.path);
for(const file of files){
if(!file.name.match(/\.(zip|kml|kmz)$/i)) continue;
layerStore[file.path]={
url:file.download_url,
layer:null,
marker:null
};
}

yToggle.onclick=()=>toggleYear(year.path,yToggle);
}

// Bulk kategori (tidak mengunci tahun)
toggle.onclick=async ()=>{
const active=!toggle.classList.contains("active");
toggle.classList.toggle("active");

const yearToggles=yearContainer.querySelectorAll(".toggle");

for(const yToggle of yearToggles){
if(active && !yToggle.classList.contains("active")){
yToggle.classList.add("active");
await toggleYear(yToggle.dataset.path,yToggle,true);
}
if(!active && yToggle.classList.contains("active")){
yToggle.classList.remove("active");
await toggleYear(yToggle.dataset.path,yToggle,false);
}
}
};
}

loading.style.display="none";
}

async function toggleYear(path,btn,force=null){

let active;
if(force!==null){
active=force;
}else{
btn.classList.toggle("active");
active=btn.classList.contains("active");
}

for(let key in layerStore){
if(key.startsWith(path)){
if(active){
await loadLayer(key);
}else{
if(layerStore[key].layer){
map.removeLayer(layerStore[key].layer);
map.removeLayer(layerStore[key].marker);
}
}
}
}
}

async function loadLayer(key){

if(layerStore[key].layer){
map.addLayer(layerStore[key].layer);
map.addLayer(layerStore[key].marker);
map.fitBounds(layerStore[key].layer.getBounds());
return;
}

let layer;

if(layerStore[key].url.endsWith(".zip")){
const res=await fetch(layerStore[key].url);
const buffer=await res.arrayBuffer();
const data=await shp(buffer);
layer=L.geoJSON(data).addTo(map);
}else{
layer=omnivore.kml(layerStore[key].url).addTo(map);
}

layer.on("ready",()=>{
const center=layer.getBounds().getCenter();
const icon=L.icon({
iconUrl:markerImage,
iconSize:[30,30],
iconAnchor:[15,30]
});
const marker=L.marker(center,{icon}).addTo(map);
layerStore[key].marker=marker;
map.fitBounds(layer.getBounds());
});

layerStore[key].layer=layer;
}

loadStructure();
</script>
</body>
</html>
