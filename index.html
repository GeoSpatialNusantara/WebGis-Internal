<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebGIS - GeoSpatialNusantara</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{margin:0;font-family:Arial, sans-serif;overflow:hidden;}
#map{height:100vh;width:100%;}

/* ===== SIDEBAR ===== */
#sidebar{
    position:absolute;
    top:0;
    right:0;
    width:360px;
    height:100vh;
    background:#f4f4f4;
    border-left:1px solid #ccc;
    padding:15px;
    box-sizing:border-box;
    overflow:auto;
    transform:translateX(100%);
    transition:0.3s;
    z-index:1000;
}
#sidebar.active{transform:translateX(0);}

#toggleBtn{
    position:absolute;
    top:15px;
    right:15px;
    z-index:1100;
    background:white;
    border:none;
    padding:8px 12px;
    font-size:18px;
    border-radius:6px;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
    cursor:pointer;
}

/* ===== STRUCTURE ===== */
.row{
    display:flex;
    align-items:center;
    margin-top:8px;
}

.label{
    cursor:pointer;
    user-select:none;
}

.category-label{
    font-weight:bold;
}

.year-label{
    margin-left:10px;
}

/* Toggle kecil abu */
.toggle{
    width:12px;
    height:12px;
    border-radius:50%;
    border:2px solid #888;
    margin-right:8px;
    cursor:pointer;
    transition:0.2s;
}
.toggle.active{
    background:#666;
    border-color:#666;
}

.children{display:none;margin-left:15px;}
.children.active{display:block;}

.leaflet-tooltip{
    background:white;
    border-radius:6px;
    padding:4px 8px;
    font-weight:bold;
    border:1px solid #ccc;
}
</style>
</head>

<body>

<div id="map"></div>
<button id="toggleBtn">☰</button>

<div id="sidebar">
    <h2>Layer Control</h2>
    <div id="fileList">Loading...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>

<script>

// ===== CONFIG =====
const OWNER = "GeoSpatialNusantara";
const REPO = "WebGis";
const ROOT_FOLDER = "file";
const BRANCH = "main";
const markerImage = "./img/point-of-interest.png";

let layerStore = {};
let markerStore = {};

// ===== MAP =====
const map = L.map('map',{minZoom:5,maxZoom:18})
.setView([-2.5,118],5);

L.tileLayer(
'https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
{ subdomains:['mt0','mt1','mt2','mt3'] }
).addTo(map);

document.getElementById("toggleBtn")
.addEventListener("click",()=>{
    document.getElementById("sidebar")
    .classList.toggle("active");
});

function createIcon(size){
    return L.icon({
        iconUrl:markerImage,
        iconSize:[size,size],
        iconAnchor:[size/2,size]
    });
}

async function fetchGitHub(path){
    const url=`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}?ref=${BRANCH}`;
    const res=await fetch(url);
    return await res.json();
}

// ===== LOAD STRUCTURE =====
async function loadStructure(){

    const container=document.getElementById("fileList");
    container.innerHTML="";

    const categories = await fetchGitHub(ROOT_FOLDER);

    for(const cat of categories){
        if(cat.type!=="dir") continue;

        // ===== CATEGORY ROW =====
        const catRow=document.createElement("div");
        catRow.className="row";

        const catToggle=document.createElement("div");
        catToggle.className="toggle active";

        const catLabel=document.createElement("span");
        catLabel.className="label category-label";
        catLabel.innerHTML="▶ "+cat.name;

        catRow.appendChild(catToggle);
        catRow.appendChild(catLabel);
        container.appendChild(catRow);

        const yearContainer=document.createElement("div");
        yearContainer.className="children active";
        container.appendChild(yearContainer);

        // Expand collapse kategori
        catLabel.onclick=()=>{
            yearContainer.classList.toggle("active");
            catLabel.innerHTML=yearContainer.classList.contains("active")
                ? "▼ "+cat.name
                : "▶ "+cat.name;
        };

        // Toggle kategori ON/OFF
        catToggle.onclick=(e)=>{
            e.stopPropagation();
            catToggle.classList.toggle("active");
            const active=catToggle.classList.contains("active");

            for(let key in layerStore){
                if(key.startsWith(cat.path)){
                    if(active){
                        map.addLayer(layerStore[key]);
                        map.addLayer(markerStore[key]);
                    }else{
                        map.removeLayer(layerStore[key]);
                        map.removeLayer(markerStore[key]);
                    }
                }
            }
        };

        const years=await fetchGitHub(cat.path);

        for(const year of years){
            if(year.type!=="dir") continue;

            // ===== YEAR ROW =====
            const yearRow=document.createElement("div");
            yearRow.className="row";

            const yearToggle=document.createElement("div");
            yearToggle.className="toggle active";

            const yearLabel=document.createElement("span");
            yearLabel.className="label year-label";
            yearLabel.textContent=year.name;

            yearRow.appendChild(yearToggle);
            yearRow.appendChild(yearLabel);
            yearContainer.appendChild(yearRow);

            const files=await fetchGitHub(year.path);

            for(const file of files){
                if(!file.name.endsWith(".zip")) continue;

                await loadLayer(
                    file.path,
                    file.download_url,
                    file.name.replace(".zip","")
                );
            }

            // Toggle tahun ON/OFF
            yearToggle.onclick=(e)=>{
                e.stopPropagation();
                yearToggle.classList.toggle("active");
                const active=yearToggle.classList.contains("active");

                for(let key in layerStore){
                    if(key.startsWith(year.path)){
                        if(active){
                            map.addLayer(layerStore[key]);
                            map.addLayer(markerStore[key]);
                        }else{
                            map.removeLayer(layerStore[key]);
                            map.removeLayer(markerStore[key]);
                        }
                    }
                }
            };
        }
    }
}

// ===== LOAD LAYER =====
async function loadLayer(key,url,name){

    const res=await fetch(url);
    const arrayBuffer=await res.arrayBuffer();
    const data=await shp(arrayBuffer);

    const layer=L.geoJSON(data).addTo(map);
    layerStore[key]=layer;

    const center=layer.getBounds().getCenter();
    const size=Math.max(35,map.getZoom()*2);

    const marker=L.marker(center,{icon:createIcon(size)}).addTo(map);

    marker.bindTooltip(name,{direction:"top"});

    marker.on("mouseover",()=>{
        marker.setIcon(createIcon(size*1.4));
        marker.openTooltip();
    });

    marker.on("mouseout",()=>{
        marker.setIcon(createIcon(size));
        marker.closeTooltip();
    });

    marker.on("click",()=>{
        map.fitBounds(layer.getBounds());
    });

    markerStore[key]=marker;
}

// Resize marker saat zoom
map.on("zoomend",()=>{
    const size=Math.max(35,map.getZoom()*2);
    for(let key in markerStore){
        markerStore[key].setIcon(createIcon(size));
    }
});

loadStructure();

</script>
</body>
</html>
