<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>WebGIS - GeoSpatialNusantara</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>

<style>
html, body { margin:0; height:100%; }
#map { height:100%; width:100%; }

.sidebar {
  position:absolute;
  top:0;
  right:0;
  width:320px;
  height:100%;
  background:white;
  overflow:auto;
  padding:15px;
  box-shadow:-3px 0 8px rgba(0,0,0,0.3);
  z-index:1000;
}

.layer-item { margin-left:10px; }
.category { font-weight:bold; cursor:pointer; margin-top:10px; }
.year { margin-left:15px; }

.toggle {
  display:inline-block;
  width:14px;
  height:14px;
  border-radius:50%;
  background:#ccc;
  margin-right:6px;
  cursor:pointer;
}
.toggle.active { background:green; }

.basemap-btn {
  position:absolute;
  top:10px;
  left:10px;
  z-index:1100;
  background:white;
  padding:8px;
  cursor:pointer;
  border-radius:4px;
  box-shadow:0 0 5px rgba(0,0,0,0.3);
}

.basemap-menu {
  position:absolute;
  top:50px;
  left:10px;
  background:white;
  padding:10px;
  display:none;
  box-shadow:0 0 5px rgba(0,0,0,0.3);
  z-index:1100;
}
.basemap-menu div {
  cursor:pointer;
  margin-bottom:5px;
}
</style>
</head>
<body>

<div id="map"></div>

<!-- Basemap Button -->
<div class="basemap-btn" onclick="toggleBasemap()">☰</div>

<div class="basemap-menu" id="basemapMenu">
  <div onclick="setBasemap('osm')">OpenStreetMap</div>
  <div onclick="setBasemap('sat')">Satellite</div>
  <div onclick="setBasemap('topo')">Topo</div>
</div>

<!-- Sidebar -->
<div class="sidebar">
  <h2>Layer Control</h2>
  <div id="layerList"></div>
</div>

<script>

var map = L.map('map').setView([-2.5, 118], 5);

var basemaps = {
  osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
  sat: L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png'),
  topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png')
};

basemaps.osm.addTo(map);

function toggleBasemap(){
  var menu = document.getElementById("basemapMenu");
  menu.style.display = menu.style.display === "block" ? "none" : "block";
}

function setBasemap(name){
  for (var key in basemaps) map.removeLayer(basemaps[key]);
  basemaps[name].addTo(map);
}

const username = "GeoSpatialNusantara";
const repo = "WebGis";
const root_folder = "file";

let loadedLayers = {};

fetch(`https://api.github.com/repos/${username}/${repo}/contents/${root_folder}`)
.then(res => res.json())
.then(categories => {

  categories.forEach(cat => {
    if(cat.type === "dir") {

      let catDiv = document.createElement("div");
      catDiv.className = "category";
      catDiv.innerHTML = "▼ " + cat.name;

      let yearContainer = document.createElement("div");
      yearContainer.style.display = "none";

      catDiv.onclick = function(){
        yearContainer.style.display =
          yearContainer.style.display === "none" ? "block" : "none";
      };

      document.getElementById("layerList").appendChild(catDiv);
      document.getElementById("layerList").appendChild(yearContainer);

      // LOAD TAHUN
      fetch(cat.url)
      .then(res => res.json())
      .then(years => {

        years.forEach(year => {
          if(year.type === "dir") {

            let yearDiv = document.createElement("div");
            yearDiv.className = "year";

            let toggle = document.createElement("span");
            toggle.className = "toggle";

            let label = document.createElement("span");
            label.innerText = year.name;

            yearDiv.appendChild(toggle);
            yearDiv.appendChild(label);
            yearContainer.appendChild(yearDiv);

            toggle.onclick = function(){

              if(toggle.classList.contains("active")) {
                toggle.classList.remove("active");

                if(loadedLayers[year.path]) {
                  map.removeLayer(loadedLayers[year.path]);
                }

              } else {

                toggle.classList.add("active");

                fetch(year.url)
                .then(res => res.json())
                .then(files => {

                  files.forEach(file => {

                    if(file.name.endsWith(".kml") || 
                       file.name.endsWith(".kmz") ||
                       file.name.endsWith(".zip")) {

                      let rawUrl = `https://raw.githubusercontent.com/${username}/${repo}/main/${file.path}`;

                      let layer = omnivore.kml(rawUrl)
                        .on('ready', function() {
                          map.fitBounds(layer.getBounds());
                        })
                        .on('mouseover', function(e){
                          let cleanName = file.name
                            .replace(".zip","")
                            .replace(".kml","")
                            .replace(".kmz","");

                          e.layer.bindTooltip(cleanName).openTooltip();
                        })
                        .addTo(map);

                      loadedLayers[year.path] = layer;
                    }

                  });

                });

              }

            };

          }
        });

      });

    }
  });

});

</script>
</body>
</html>
